<?xml version="1.0" encoding="utf-8"?> 
<createCustomerProfileTransactionRequest xmlns="AnetApi/xml/v1/schema/AnetApiSchema.xsd"> 
{% include "bursar/auth.xml" %}
    <transaction>
        <{{ action }}>
            {% if action != 'profileTransVoid' %}
                {% if authorization %}
            <amount>{{ authorization.amount }}</amount>
                {% else %}{%if pending %}
            <amount>{{ pending.amount }}</amount>
                {% else %}
            <amount>{{ purchase.total }}</amount>
                {% endif %}{% endif %}
            {% endif %}
            {% if purchase.tax %}
            <tax>
                <amount>{{ purchase.tax }}</amount>
            </tax>
            {% endif %}
            {% if purchase.shipping %}
            <shipping>
                <amount>{{ purchase.shipping }}</amount>
            </shipping>
            {% endif %}
            <customerProfileId>{{ cim_purchase.customer_profile_id }}</customerProfileId>     
            <customerPaymentProfileId>{{ cim_purchase.customer_profile_id }}</customerPaymentProfileId>     
            <customerShippingAddressId>{{ cim_purchase.shipping_address_id }}</customerShippingAddressId>
            {% if action != 'profileTransVoid' and action != 'profileTransPriorAuthCapture'%}
            <order>
                <invoiceNumber>{{ purchase.orderno }}</invoiceNumber>
            </order>
                {% if purchase.tax %}
            <taxExempt>false</taxExempt>
                {% else %}
            <taxExempt>true</taxExempt>
                {% endif %}
                {% if purchase.credit_card.getCCV %}
            <cardCode>{{ purchase.credit_card.getCCV }}</cardCode>
                {% endif %}
            {% endif %}
            {% if transaction_id %}
            <transId>{{ transaction_id }}</transId>
            {% endif %}
        </{{ action }}>
    </transaction>
{% if extra_options %}
<extraOptions><![CDATA[{{extra_options}}]]></extraOptions>
{% endif %}
</createCustomerProfileTransactionRequest>
